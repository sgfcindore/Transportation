<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Parking System - SGFC Enterprise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .data-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .data-table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: white;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .data-table th:first-child {
      border-radius: 12px 0 0 0;
    }
    
    .data-table th:last-child {
      border-radius: 0 12px 0 0;
    }
    
    .data-table tbody tr {
      background: white;
      transition: all 0.2s ease;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9ff;
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    .data-table td {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-success { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .badge-warning { 
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    
    .badge-danger { 
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.2s;
      background: white;
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    .btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 12px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(16, 185, 129, 0.5);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid white;
      color: white;
    }
    
    .btn-outline:hover {
      background: white;
      color: #667eea;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-container {
      background: white;
      border-radius: 24px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-header {
      padding: 32px;
      border-bottom: 2px solid #f3f4f6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 24px 24px 0 0;
    }
    
    .modal-title {
      font-size: 28px;
      font-weight: 800;
      color: white;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 32px;
    }
    
    .modal-footer {
      padding: 24px 32px;
      border-top: 2px solid #f3f4f6;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: #f9fafb;
      border-radius: 0 0 24px 24px;
    }
    
    .hidden {
      display: none;
    }
    
    .tab-button {
      position: relative;
      padding: 16px 32px;
      background: transparent;
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tab-button:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .tab-button.active {
      background: rgba(255, 255, 255, 0.2);
      border-bottom: 3px solid white;
    }
    
    .icon-bg {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }
    
    .vehicle-number {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      font-size: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .info-card {
      background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);
      border-left: 4px solid #667eea;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
    }
    
    .amount-display {
      font-size: 36px;
      font-weight: 800;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="glass-effect sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-8 py-6">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-black text-gray-900 tracking-tight">SMART PARKING SYSTEM</h1>
            <p class="text-sm text-gray-600 font-medium">SGFC Enterprise Solutions ‚Ä¢ Real-time Management</p>
          </div>
        </div>
        <button onclick="window.location.href='home.html'" class="btn btn-outline">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Dashboard
        </button>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <div class="max-w-7xl mx-auto px-8 py-8 space-y-8">
    
    <!-- Stats Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Stat Card 1 -->
      <div class="stat-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="icon-bg">
            <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
          </div>
          <span class="text-4xl">üÖøÔ∏è</span>
        </div>
        <h3 class="text-gray-600 text-sm font-semibold mb-2 uppercase tracking-wide">Active Vehicles</h3>
        <p class="text-4xl font-black text-gray-900" id="statCurrentlyParked">0</p>
        <p class="text-sm text-gray-500 mt-2 font-medium">Currently parked</p>
      </div>

      <!-- Stat Card 2 -->
      <div class="stat-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="icon-bg">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <span class="text-4xl">üí∞</span>
        </div>
        <h3 class="text-gray-600 text-sm font-semibold mb-2 uppercase tracking-wide">Current Revenue</h3>
        <p class="text-4xl font-black text-green-600" id="statCurrentRevenue">‚Çπ0</p>
        <p class="text-sm text-gray-500 mt-2 font-medium">Active parking</p>
      </div>

      <!-- Stat Card 3 -->
      <div class="stat-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="icon-bg">
            <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
          </div>
          <span class="text-4xl">üìä</span>
        </div>
        <h3 class="text-gray-600 text-sm font-semibold mb-2 uppercase tracking-wide">Total Revenue</h3>
        <p class="text-4xl font-black text-indigo-600" id="statTotalRevenue">‚Çπ0</p>
        <p class="text-sm text-gray-500 mt-2 font-medium">All time earnings</p>
      </div>

      <!-- Stat Card 4 -->
      <div class="stat-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="icon-bg">
            <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <span class="text-4xl">‚úÖ</span>
        </div>
        <h3 class="text-gray-600 text-sm font-semibold mb-2 uppercase tracking-wide">Today's Checkouts</h3>
        <p class="text-4xl font-black text-orange-600" id="statCompletedToday">0</p>
        <p class="text-sm text-gray-500 mt-2 font-medium">Completed today</p>
      </div>
    </div>

    <!-- Action Bar -->
    <div class="glass-card rounded-2xl p-6">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex gap-3">
          <button onclick="showTab('active')" class="tab-button active" id="btnActiveTab">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            Active Parking
          </button>
          <button onclick="showTab('completed')" class="tab-button" id="btnCompletedTab">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Completed
          </button>
        </div>
        <button onclick="openAddParkingModal()" class="btn btn-primary">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          New Vehicle Entry
        </button>
      </div>
    </div>

    <!-- Active Parking Tab -->
    <div id="activeTab" class="glass-card rounded-2xl overflow-hidden">
      <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-8">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
            <svg class="w-9 h-9 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <h2 class="text-3xl font-black text-white tracking-tight">ACTIVE PARKING</h2>
            <p class="text-purple-100 font-medium">Real-time vehicle monitoring</p>
          </div>
        </div>
      </div>
      
      <div class="p-8" id="activeParkingList"></div>
    </div>

    <!-- Completed Parking Tab -->
    <div id="completedTab" class="glass-card rounded-2xl overflow-hidden hidden">
      <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-8">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
            <svg class="w-9 h-9 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <h2 class="text-3xl font-black text-white tracking-tight">COMPLETED PARKING</h2>
            <p class="text-green-100 font-medium">Historical records & analytics</p>
          </div>
        </div>
      </div>
      
      <div class="p-8" id="completedParkingList"></div>
    </div>

  </div>

  <!-- Modal Container -->
  <div id="modalContainer"></div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-8 right-8 transform translate-x-full transition-all duration-500 z-50" style="min-width: 350px;">
    <div class="glass-card rounded-2xl p-6 shadow-2xl">
      <div class="flex items-center gap-4">
        <div id="toastIcon" class="flex-shrink-0"></div>
        <p id="toastMessage" class="font-semibold text-gray-900"></p>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDXjS_eZykW2vCBUvb0cFRQemsAd2A6AFQ",
      authDomain: "sgfc-transportation-ba8ec.firebaseapp.com",
      projectId: "sgfc-transportation-ba8ec",
      storageBucket: "sgfc-transportation-ba8ec.firebasestorage.app",
      messagingSenderId: "728467386632",
      appId: "1:728467386632:web:3b0f2faf6abb2b36bd1a64"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global state
    let parkingRecords = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadParkingRecords();
    });

    // Load parking records from Firebase
    async function loadParkingRecords() {
      try {
        const snapshot = await db.collection('parking').orderBy('entryDate', 'desc').get();
        parkingRecords = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        updateStats();
        renderActiveParkingList();
        renderCompletedParkingList();
      } catch (error) {
        console.error('Error loading parking records:', error);
        showToast('Error loading data', 'error');
      }
    }

    // Calculate days with 12 PM rule
    function calculateDaysWithTime(entryDate, entryTime, exitDate = null, exitTime = null) {
      const entry = new Date(`${entryDate}T${entryTime}`);
      const exit = exitDate && exitTime ? new Date(`${exitDate}T${exitTime}`) : new Date();
      
      const diffMs = exit - entry;
      const baseDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      const exitHour = exit.getHours();
      const exitMinutes = exit.getMinutes();
      const exitTimeMinutes = exitHour * 60 + exitMinutes;
      const noonMinutes = 12 * 60;
      
      const remainingMs = diffMs % (1000 * 60 * 60 * 24);
      const remainingHours = remainingMs / (1000 * 60 * 60);
      
      let chargeDays = baseDays;
      
      if (baseDays === 0) {
        if (exitTimeMinutes > noonMinutes) {
          chargeDays = 1;
        } else {
          chargeDays = 1;
        }
      } else {
        if (remainingHours > 0) {
          if (exitTimeMinutes > noonMinutes) {
            chargeDays = baseDays + 1;
          } else {
            chargeDays = baseDays;
          }
        } else {
          chargeDays = baseDays;
        }
      }
      
      return Math.max(1, chargeDays);
    }

    // Update statistics
    function updateStats() {
      const activeRecords = parkingRecords.filter(r => r.status === 'active');
      const completedRecords = parkingRecords.filter(r => r.status === 'completed');
      
      document.getElementById('statCurrentlyParked').textContent = activeRecords.length;
      
      const currentRevenue = activeRecords.reduce((sum, r) => {
        const days = calculateDaysWithTime(r.entryDate, r.entryTime || '00:00');
        return sum + (days * r.ratePerDay);
      }, 0);
      document.getElementById('statCurrentRevenue').textContent = '‚Çπ' + currentRevenue.toLocaleString('en-IN');
      
      const totalRevenue = completedRecords.reduce((sum, r) => sum + (r.totalAmount || 0), 0) + currentRevenue;
      document.getElementById('statTotalRevenue').textContent = '‚Çπ' + totalRevenue.toLocaleString('en-IN');
      
      const today = new Date().toISOString().split('T')[0];
      const completedToday = completedRecords.filter(r => r.exitDate?.startsWith(today)).length;
      document.getElementById('statCompletedToday').textContent = completedToday;
    }

    // Render active parking list
    function renderActiveParkingList() {
      const container = document.getElementById('activeParkingList');
      const activeRecords = parkingRecords.filter(r => r.status === 'active');
      
      if (activeRecords.length === 0) {
        container.innerHTML = `
          <div class="text-center py-20">
            <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-3xl flex items-center justify-center">
              <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
            </div>
            <p class="text-xl font-bold text-gray-900 mb-2">No Active Parking</p>
            <p class="text-gray-500 font-medium mb-6">Add a new vehicle to start tracking</p>
            <button onclick="openAddParkingModal()" class="btn btn-primary">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
              Add Vehicle
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div class="overflow-x-auto rounded-xl">
          <table class="data-table">
            <thead>
              <tr>
                <th>VEHICLE</th>
                <th>OWNER / DRIVER</th>
                <th>ENTRY</th>
                <th>DURATION</th>
                <th>RATE</th>
                <th>AMOUNT</th>
                <th>CONTACT</th>
                <th class="text-center">ACTIONS</th>
              </tr>
            </thead>
            <tbody>
              ${activeRecords.map(record => {
                const days = calculateDaysWithTime(record.entryDate, record.entryTime || '00:00');
                const currentAmount = days * record.ratePerDay;
                return `
                  <tr>
                    <td>
                      <span class="vehicle-number">${record.vehicleNumber}</span>
                    </td>
                    <td>
                      <div>
                        <p class="font-bold text-gray-900">${record.ownerName}</p>
                        ${record.driverName ? `<p class="text-sm text-gray-500 font-medium">Driver: ${record.driverName}</p>` : ''}
                      </div>
                    </td>
                    <td>
                      <div>
                        <p class="font-semibold text-gray-900">${formatDate(record.entryDate)}</p>
                        <p class="text-sm text-gray-500 font-medium">${formatTime(record.entryTime || '00:00')}</p>
                      </div>
                    </td>
                    <td>
                      <span class="badge badge-warning">${days} DAY${days !== 1 ? 'S' : ''}</span>
                    </td>
                    <td class="font-bold text-gray-900">‚Çπ${record.ratePerDay}/day</td>
                    <td class="font-black text-green-600 text-lg">‚Çπ${currentAmount.toLocaleString('en-IN')}</td>
                    <td class="font-medium text-gray-700">${record.contactNumber || '-'}</td>
                    <td class="text-center">
                      <div class="flex gap-2 justify-center">
                        <button onclick="editParking('${record.id}')" class="btn btn-warning btn-sm" title="Edit">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                          </svg>
                        </button>
                        <button onclick="checkoutVehicle('${record.id}')" class="btn btn-success btn-sm">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                          </svg>
                          CHECKOUT
                        </button>
                        <button onclick="deleteParking('${record.id}')" class="btn btn-danger btn-sm">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Render completed parking list
    function renderCompletedParkingList() {
      const container = document.getElementById('completedParkingList');
      const completedRecords = parkingRecords.filter(r => r.status === 'completed');
      
      if (completedRecords.length === 0) {
        container.innerHTML = `
          <div class="text-center py-20">
            <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-green-100 to-emerald-100 rounded-3xl flex items-center justify-center">
              <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <p class="text-xl font-bold text-gray-900 mb-2">No Completed Records</p>
            <p class="text-gray-500 font-medium">Checkout history will appear here</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div class="overflow-x-auto rounded-xl">
          <table class="data-table">
            <thead>
              <tr>
                <th>VEHICLE</th>
                <th>OWNER / DRIVER</th>
                <th>ENTRY</th>
                <th>EXIT</th>
                <th>DURATION</th>
                <th>CALCULATED</th>
                <th>DISCOUNT</th>
                <th>FINAL PAID</th>
              </tr>
            </thead>
            <tbody>
              ${completedRecords.map(record => {
                const hasDiscount = record.discountApplied && record.discountAmount > 0;
                const calculatedAmt = record.calculatedAmount || record.totalAmount;
                return `
                <tr>
                  <td>
                    <span class="vehicle-number">${record.vehicleNumber}</span>
                  </td>
                  <td>
                    <div>
                      <p class="font-bold text-gray-900">${record.ownerName}</p>
                      ${record.driverName ? `<p class="text-sm text-gray-500 font-medium">Driver: ${record.driverName}</p>` : ''}
                    </div>
                  </td>
                  <td>
                    <div>
                      <p class="font-semibold text-gray-900">${formatDate(record.entryDate)}</p>
                      <p class="text-sm text-gray-500 font-medium">${formatTime(record.entryTime || '00:00')}</p>
                    </div>
                  </td>
                  <td>
                    <div>
                      <p class="font-semibold text-gray-900">${formatDate(record.exitDate)}</p>
                      <p class="text-sm text-gray-500 font-medium">${formatTime(record.exitTime || '00:00')}</p>
                    </div>
                  </td>
                  <td>
                    <span class="badge badge-success">${record.totalDays} DAY${record.totalDays !== 1 ? 'S' : ''}</span>
                  </td>
                  <td class="font-bold text-gray-700">‚Çπ${calculatedAmt.toLocaleString('en-IN')}</td>
                  <td>
                    ${hasDiscount ? `
                      <div>
                        <span class="badge" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white;">
                          ${Math.round(record.discountPercentage || 0)}% OFF
                        </span>
                        <p class="text-xs text-gray-500 mt-1 font-medium">‚Çπ${record.discountAmount.toLocaleString('en-IN')}</p>
                        ${record.discountReason ? `<p class="text-xs text-gray-400 italic mt-1">${record.discountReason}</p>` : ''}
                      </div>
                    ` : '<span class="text-gray-400 text-sm">-</span>'}
                  </td>
                  <td class="font-black text-green-600 text-lg">‚Çπ${record.totalAmount.toLocaleString('en-IN')}</td>
                </tr>
              `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Open add parking modal
    function openAddParkingModal() {
      const now = new Date();
      const modal = `
        <div class="modal-overlay" onclick="if(event.target===this) closeModal()">
          <div class="modal-container">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h2 class="modal-title">NEW VEHICLE ENTRY</h2>
              <button class="modal-close" onclick="closeModal()">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <form id="addParkingForm" onsubmit="addParking(event)">
                <div class="space-y-5">
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Vehicle Number *</label>
                    <input type="text" id="vehicleNumber" class="form-input" required placeholder="e.g., GJ-01-AB-1234">
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Owner Name *</label>
                      <input type="text" id="ownerName" class="form-input" required placeholder="Owner's name">
                    </div>
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Driver Name</label>
                      <input type="text" id="driverName" class="form-input" placeholder="Driver's name (optional)">
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Contact Number</label>
                    <input type="tel" id="contactNumber" class="form-input" placeholder="Contact number (optional)">
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Entry Date *</label>
                      <input type="date" id="entryDate" class="form-input" required value="${now.toISOString().split('T')[0]}">
                    </div>
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Entry Time *</label>
                      <input type="time" id="entryTime" class="form-input" required value="${now.toTimeString().slice(0, 5)}">
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Rate Per Day (‚Çπ) *</label>
                    <input type="number" id="ratePerDay" class="form-input" required min="0" placeholder="e.g., 100">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Notes</label>
                    <textarea id="notes" class="form-textarea" rows="3" placeholder="Additional notes (optional)"></textarea>
                  </div>
                  
                  <div class="info-card">
                    <div class="flex items-start gap-3">
                      <svg class="w-6 h-6 text-purple-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                      <div>
                        <p class="font-bold text-gray-900 mb-1">Charging Policy</p>
                        <p class="text-sm text-gray-600 font-medium">Next day charge applies if vehicle exits after 12:00 PM (noon). Same day exits before 12:00 PM will not incur additional charges.</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="modal-footer">
                  <button type="button" onclick="closeModal()" class="btn btn-secondary">
                    CANCEL
                  </button>
                  <button type="submit" class="btn btn-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    ADD VEHICLE
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('modalContainer').innerHTML = modal;
    }

    // Edit parking
    function editParking(id) {
      const record = parkingRecords.find(r => r.id === id);
      if (!record) return;
      
      const modal = `
        <div class="modal-overlay" onclick="if(event.target===this) closeModal()">
          <div class="modal-container">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h2 class="modal-title">EDIT PARKING RECORD</h2>
              <button class="modal-close" onclick="closeModal()">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <form id="editParkingForm" onsubmit="updateParking(event, '${id}')">
                <div class="space-y-5">
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Vehicle Number *</label>
                    <input type="text" id="editVehicleNumber" class="form-input" required value="${record.vehicleNumber}">
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Owner Name *</label>
                      <input type="text" id="editOwnerName" class="form-input" required value="${record.ownerName}">
                    </div>
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Driver Name</label>
                      <input type="text" id="editDriverName" class="form-input" value="${record.driverName || ''}">
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Contact Number</label>
                    <input type="tel" id="editContactNumber" class="form-input" value="${record.contactNumber || ''}">
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Entry Date *</label>
                      <input type="date" id="editEntryDate" class="form-input" required value="${record.entryDate}">
                    </div>
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Entry Time *</label>
                      <input type="time" id="editEntryTime" class="form-input" required value="${record.entryTime || '00:00'}">
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Rate Per Day (‚Çπ) *</label>
                    <input type="number" id="editRatePerDay" class="form-input" required min="0" value="${record.ratePerDay}">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Notes</label>
                    <textarea id="editNotes" class="form-textarea" rows="3">${record.notes || ''}</textarea>
                  </div>
                </div>
                
                <div class="modal-footer">
                  <button type="button" onclick="closeModal()" class="btn btn-secondary">
                    CANCEL
                  </button>
                  <button type="submit" class="btn btn-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    UPDATE RECORD
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('modalContainer').innerHTML = modal;
    }

    // Update parking
    async function updateParking(event, id) {
      event.preventDefault();
      
      const updatedData = {
        vehicleNumber: document.getElementById('editVehicleNumber').value.toUpperCase(),
        ownerName: document.getElementById('editOwnerName').value,
        driverName: document.getElementById('editDriverName').value,
        contactNumber: document.getElementById('editContactNumber').value,
        entryDate: document.getElementById('editEntryDate').value,
        entryTime: document.getElementById('editEntryTime').value,
        ratePerDay: parseFloat(document.getElementById('editRatePerDay').value),
        notes: document.getElementById('editNotes').value,
        updatedAt: new Date().toISOString()
      };
      
      try {
        await db.collection('parking').doc(id).update(updatedData);
        showToast('Record updated successfully!', 'success');
        closeModal();
        loadParkingRecords();
      } catch (error) {
        console.error('Error updating parking:', error);
        showToast('Error updating record', 'error');
      }
    }

    // Add parking
    async function addParking(event) {
      event.preventDefault();
      
      const parkingData = {
        vehicleNumber: document.getElementById('vehicleNumber').value.toUpperCase(),
        ownerName: document.getElementById('ownerName').value,
        driverName: document.getElementById('driverName').value,
        contactNumber: document.getElementById('contactNumber').value,
        entryDate: document.getElementById('entryDate').value,
        entryTime: document.getElementById('entryTime').value,
        ratePerDay: parseFloat(document.getElementById('ratePerDay').value),
        notes: document.getElementById('notes').value,
        status: 'active',
        createdAt: new Date().toISOString()
      };
      
      try {
        await db.collection('parking').add(parkingData);
        showToast('Vehicle added successfully!', 'success');
        closeModal();
        loadParkingRecords();
      } catch (error) {
        console.error('Error adding parking:', error);
        showToast('Error adding vehicle', 'error');
      }
    }

    // Checkout vehicle
    async function checkoutVehicle(id) {
      const record = parkingRecords.find(r => r.id === id);
      if (!record) return;
      
      const now = new Date();
      const exitDate = now.toISOString().split('T')[0];
      const exitTime = now.toTimeString().slice(0, 5);
      
      const days = calculateDaysWithTime(record.entryDate, record.entryTime || '00:00', exitDate, exitTime);
      const calculatedAmount = days * record.ratePerDay;
      
      const modal = `
        <div class="modal-overlay" onclick="if(event.target===this) closeModal()">
          <div class="modal-container">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h2 class="modal-title">CHECKOUT VEHICLE</h2>
              <button class="modal-close" onclick="closeModal()">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="info-card mb-6">
                <div class="space-y-3 mb-6">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-gray-600 uppercase">Vehicle</span>
                    <span class="vehicle-number">${record.vehicleNumber}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-gray-600 uppercase">Owner</span>
                    <span class="font-bold text-gray-900">${record.ownerName}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-gray-600 uppercase">Entry</span>
                    <span class="font-medium text-gray-700">${formatDate(record.entryDate)} ${formatTime(record.entryTime || '00:00')}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-gray-600 uppercase">Exit</span>
                    <span class="font-medium text-gray-700">${formatDate(exitDate)} ${formatTime(exitTime)}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-gray-600 uppercase">Total Days</span>
                    <span class="badge badge-warning">${days} DAY${days !== 1 ? 'S' : ''}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-gray-600 uppercase">Rate</span>
                    <span class="font-bold text-gray-900">‚Çπ${record.ratePerDay}/day</span>
                  </div>
                  <hr style="border-top: 2px solid #e5e7eb; margin: 16px 0;">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-700 uppercase">Calculated Amount</span>
                    <span class="font-bold text-lg text-gray-900">‚Çπ${calculatedAmount.toLocaleString('en-IN')}</span>
                  </div>
                </div>
              </div>
              
              <!-- Discount Section -->
              <div style="background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%); border-left: 4px solid #667eea; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                <div class="flex items-center gap-3 mb-4">
                  <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <h3 class="font-bold text-gray-900 text-lg">Apply Discount (Optional)</h3>
                </div>
                
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Discount Type</label>
                    <select id="discountType" class="form-select" onchange="updateFinalAmount(${calculatedAmount})">
                      <option value="none">No Discount</option>
                      <option value="percentage">Percentage (%)</option>
                      <option value="fixed">Fixed Amount (‚Çπ)</option>
                      <option value="custom">Custom Final Amount</option>
                    </select>
                  </div>
                  
                  <div id="discountValueContainer" class="hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Discount Value</label>
                    <input type="number" id="discountValue" class="form-input" min="0" placeholder="Enter discount" oninput="updateFinalAmount(${calculatedAmount})">
                  </div>
                  
                  <div id="customAmountContainer" class="hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Final Settlement Amount</label>
                    <input type="number" id="customAmount" class="form-input" min="0" value="${calculatedAmount}" oninput="updateCustomFinalAmount()">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Discount Reason</label>
                    <input type="text" id="discountReason" class="form-input" placeholder="e.g., Known vehicle, Regular customer (optional)">
                  </div>
                </div>
              </div>
              
              <!-- Final Amount Display -->
              <div class="text-center mb-6">
                <p class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2">Final Amount to Pay</p>
                <p class="amount-display" id="finalAmountDisplay">‚Çπ${calculatedAmount.toLocaleString('en-IN')}</p>
                <p id="discountInfo" class="text-sm font-semibold text-green-600 mt-2 hidden"></p>
              </div>
              
              <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                <div class="flex items-start gap-3">
                  <svg class="w-5 h-5 text-orange-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                  </svg>
                  <p class="text-sm font-semibold text-orange-900">
                    ${exitTime >= '12:00' ? '‚ö†Ô∏è Exit time is after 12:00 PM - Full day charge applied' : '‚úì Exit time is before 12:00 PM - No extra day charge'}
                  </p>
                </div>
              </div>
              
              <div class="modal-footer">
                <button onclick="closeModal()" class="btn btn-secondary">
                  CANCEL
                </button>
                <button onclick="confirmCheckoutWithDiscount('${id}', ${days}, ${calculatedAmount}, '${exitDate}', '${exitTime}')" class="btn btn-success">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  CONFIRM CHECKOUT
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('modalContainer').innerHTML = modal;
    }

    // Update final amount based on discount
    function updateFinalAmount(calculatedAmount) {
      const discountType = document.getElementById('discountType').value;
      const discountValueContainer = document.getElementById('discountValueContainer');
      const customAmountContainer = document.getElementById('customAmountContainer');
      const discountValueInput = document.getElementById('discountValue');
      const finalAmountDisplay = document.getElementById('finalAmountDisplay');
      const discountInfo = document.getElementById('discountInfo');
      
      // Show/hide appropriate fields
      if (discountType === 'none') {
        discountValueContainer.classList.add('hidden');
        customAmountContainer.classList.add('hidden');
        finalAmountDisplay.textContent = '‚Çπ' + calculatedAmount.toLocaleString('en-IN');
        discountInfo.classList.add('hidden');
        return;
      } else if (discountType === 'custom') {
        discountValueContainer.classList.add('hidden');
        customAmountContainer.classList.remove('hidden');
        return;
      } else {
        discountValueContainer.classList.remove('hidden');
        customAmountContainer.classList.add('hidden');
      }
      
      const discountValue = parseFloat(discountValueInput.value) || 0;
      let finalAmount = calculatedAmount;
      let discountAmount = 0;
      
      if (discountType === 'percentage') {
        discountAmount = (calculatedAmount * discountValue) / 100;
        finalAmount = calculatedAmount - discountAmount;
      } else if (discountType === 'fixed') {
        discountAmount = discountValue;
        finalAmount = calculatedAmount - discountAmount;
      }
      
      // Ensure final amount is not negative
      finalAmount = Math.max(0, finalAmount);
      
      finalAmountDisplay.textContent = '‚Çπ' + Math.round(finalAmount).toLocaleString('en-IN');
      
      if (discountAmount > 0) {
        discountInfo.textContent = `üí∞ Discount: ‚Çπ${Math.round(discountAmount).toLocaleString('en-IN')} saved`;
        discountInfo.classList.remove('hidden');
      } else {
        discountInfo.classList.add('hidden');
      }
    }
    
    // Update custom final amount
    function updateCustomFinalAmount() {
      const customAmount = parseFloat(document.getElementById('customAmount').value) || 0;
      const finalAmountDisplay = document.getElementById('finalAmountDisplay');
      finalAmountDisplay.textContent = '‚Çπ' + Math.round(customAmount).toLocaleString('en-IN');
    }

    // Confirm checkout with discount
    async function confirmCheckoutWithDiscount(id, days, calculatedAmount, exitDate, exitTime) {
      const discountType = document.getElementById('discountType').value;
      const discountValueInput = document.getElementById('discountValue');
      const customAmountInput = document.getElementById('customAmount');
      const discountReasonInput = document.getElementById('discountReason');
      
      let finalAmount = calculatedAmount;
      let discountAmount = 0;
      let discountPercentage = 0;
      
      if (discountType === 'percentage') {
        const percentage = parseFloat(discountValueInput.value) || 0;
        discountAmount = (calculatedAmount * percentage) / 100;
        finalAmount = calculatedAmount - discountAmount;
        discountPercentage = percentage;
      } else if (discountType === 'fixed') {
        discountAmount = parseFloat(discountValueInput.value) || 0;
        finalAmount = calculatedAmount - discountAmount;
        discountPercentage = (discountAmount / calculatedAmount) * 100;
      } else if (discountType === 'custom') {
        finalAmount = parseFloat(customAmountInput.value) || calculatedAmount;
        discountAmount = calculatedAmount - finalAmount;
        discountPercentage = (discountAmount / calculatedAmount) * 100;
      }
      
      // Ensure final amount is not negative
      finalAmount = Math.max(0, Math.round(finalAmount));
      discountAmount = Math.max(0, Math.round(discountAmount));
      
      const updateData = {
        status: 'completed',
        exitDate: exitDate,
        exitTime: exitTime,
        totalDays: days,
        calculatedAmount: calculatedAmount,
        totalAmount: finalAmount,
        discountApplied: discountAmount > 0,
        discountAmount: discountAmount,
        discountPercentage: Math.round(discountPercentage * 100) / 100,
        discountType: discountType !== 'none' ? discountType : null,
        discountReason: discountReasonInput.value || null,
        completedAt: new Date().toISOString()
      };
      
      try {
        await db.collection('parking').doc(id).update(updateData);
        
        if (discountAmount > 0) {
          showToast(`‚úÖ Checkout complete! Discount: ‚Çπ${discountAmount.toLocaleString('en-IN')} (${Math.round(discountPercentage)}%)`, 'success');
        } else {
          showToast('Vehicle checked out successfully!', 'success');
        }
        
        closeModal();
        loadParkingRecords();
      } catch (error) {
        console.error('Error checking out:', error);
        showToast('Error checking out vehicle', 'error');
      }
    }

    // Delete parking
    async function deleteParking(id) {
      if (!confirm('‚ö†Ô∏è Are you sure you want to delete this parking record?\n\nThis action cannot be undone.')) return;
      
      try {
        await db.collection('parking').doc(id).delete();
        showToast('Record deleted successfully', 'success');
        loadParkingRecords();
      } catch (error) {
        console.error('Error deleting:', error);
        showToast('Error deleting record', 'error');
      }
    }

    // Show tab
    function showTab(tab) {
      const activeTab = document.getElementById('activeTab');
      const completedTab = document.getElementById('completedTab');
      const btnActive = document.getElementById('btnActiveTab');
      const btnCompleted = document.getElementById('btnCompletedTab');
      
      if (tab === 'active') {
        activeTab.classList.remove('hidden');
        completedTab.classList.add('hidden');
        btnActive.classList.add('active');
        btnCompleted.classList.remove('active');
      } else {
        activeTab.classList.add('hidden');
        completedTab.classList.remove('hidden');
        btnActive.classList.remove('active');
        btnCompleted.classList.add('active');
      }
    }

    // Close modal
    function closeModal() {
      document.getElementById('modalContainer').innerHTML = '';
    }

    // Format date
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Format time
    function formatTime(timeStr) {
      if (!timeStr) return '';
      const [hours, minutes] = timeStr.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    // Show toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      
      toastMessage.textContent = message;
      
      if (type === 'success') {
        toastIcon.innerHTML = `
          <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
        `;
      } else {
        toastIcon.innerHTML = `
          <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-rose-600 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </div>
        `;
      }
      
      toast.style.transform = 'translateX(0)';
      
      setTimeout(() => {
        toast.style.transform = 'translateX(150%)';
      }, 4000);
    }
  </script>
</body>
</html>
